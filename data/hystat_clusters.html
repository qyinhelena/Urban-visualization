<!DOCTYPE html>
<html>
<head>
<title>mapboxgl-jupyter viz</title>
<meta charset='UTF-8' />
<meta name='viewport'
      content='initial-scale=1,maximum-scale=1,user-scalable=no' />
<script type='text/javascript'
        src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.js'></script>
<link type='text/css'
      href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.0.0/mapbox-gl.css' 
      rel='stylesheet' />

<style type='text/css'>
    body { margin:0; padding:0; }
    .map { position: absolute; top:0; bottom:0; width:100%; }
    .legend {
        background-color: white;
        color: #6e6e6e;
        border-radius: 3px;
        bottom: 10px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.10);
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        padding: 0;
        position: absolute;
        right: 10px;
        z-index: 1;
        min-width: 100px;
    }
   .legend.horizontal {bottom: 10px; text-align: left;}

    /* legend header */
    .legend .legend-header { border-radius: 3px 3px 0 0; background: white; }
    .legend .legend-title {
        padding: 6px 12px 6px 12px;
        text-shadow: 0 0 2px white;
        text-transform: capitalize;
        text-align: center;
        font-weight: bold !important;
        font-size: 14px;
        font: 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
        max-width: 160px;
    }
    .legend-title {padding: 6px 12px 6px 12px; text-shadow: 0 0 2px #FFF; text-transform: capitalize; text-align: center; max-width: 160px; font-size: 0.9em; font-weight: bold;}
    .legend.horizontal .legend-title {text-align: left;}

    /* legend items */
    .legend-content {margin: 6px 12px 6px 12px; overflow: hidden; padding: 0; float: left; list-style: none; font-size: 0.8em;}
    .legend.vertical .legend-item {white-space: nowrap;}
    .legend-value {display: inline-block; line-height: 18px; vertical-align: top;}
    .legend.horizontal ul.legend-content li.legend-item .legend-value,
    .legend.horizontal ul.legend-content li.legend-item {display: inline-block; float: left; width: 30px; margin-bottom: 0; text-align: center; min-height: 30px;}

    /* legend key styles */
    .legend-key {display: inline-block; height: 10px;}
    .legend-key.default, .legend-key.square {border-radius: 0;}
    .legend-key.circle {border-radius: 50%;}
    .legend-key.rounded-square {border-radius: 20%;}
    .legend.vertical .legend-key {width: 10px; margin-right: 5px; margin-left: 1px;}
    .legend.horizontal .legend-key {width: 30px; margin-right: 0; margin-top: 1px; float: left;}
    .legend.horizontal .legend-key.square, .legend.horizontal .legend-key.rounded-square, .legend.horizontal .legend-key.circle {margin-left: 10px; width: 10px;}
    .legend.horizontal .legend-key.line {margin-left: 5px;}
    .legend.horizontal .legend-key.line, .legend.vertical .legend-key.line {border-radius: 10%; width: 20px; height: 3px; margin-bottom: 2px;}

    /* gradient bar alignment */
    .gradient-bar {margin: 6px 12px 6px 12px;}
    .legend.horizontal .gradient-bar {width: 88%; height: 10px;}
    .legend.vertical .gradient-bar {width: 10px; min-height: 50px; position: absolute; bottom: 4px;}

    /* contiguous vertical bars (discrete) */
    .legend.vertical.contig .legend-key {height: 15px; width: 10px;}
    .legend.vertical.contig li.legend-item {height: 15px;}
    .legend.vertical.contig {padding-bottom: 6px;}

    /* vertical radius legend */
    .legend.horizontal.legend-variable-radius ul.legend-content li.legend-item .legend-value,
    .legend.horizontal.legend-variable-radius ul.legend-content li.legend-item {width: 30px; min-height: 20px;}

    /* scale annotation */
    .mapboxgl-ctrl.mapboxgl-ctrl-scale { border-color: #6e6e6e; 
                                         background-color: white; 
                                         color: #131516; }
</style>


<style>
    .gradient-bar.bordered, .legend-key.bordered { border: solid black 0.1px; }
</style>


</head>
<body>

<div id='map' class='map'></div>

<script type='text/javascript'>

var legendHeader;

function calcColorLegend(myColorStops, title) {
    // create legend
    var legend = document.createElement('div'),
        legendContainer = document.getElementsByClassName('mapboxgl-ctrl-bottom-right')[0];

    if ('circle' === 'contiguous-bar') {
        legend.className = 'legend vertical contig';
    }
    else {
        legend.className = 'legend vertical';
    }
    legend.id = 'legend-0';
    document.body.appendChild(legend);
    // add legend header and content elements
    var mytitle = document.createElement('div'),
        legendContent = document.createElement('ul');
    legendHeader = document.createElement('div');
    mytitle.textContent = title;
    mytitle.className = 'legend-title'
    legendHeader.className = 'legend-header'
    legendContent.className = 'legend-content'
    legendHeader.appendChild(mytitle);
    legend.appendChild(legendHeader);
    legend.appendChild(legendContent);
    if (false === true) {
        var gradientText = 'linear-gradient(to right, ',
            gradient = document.createElement('div');
        gradient.className = 'gradient-bar';
        legend.appendChild(gradient);
    }
    // calculate a legend entries on a Mapbox GL Style Spec property function stops array
    for (p = 0; p < myColorStops.length; p++) {
        if (!!document.getElementById('legend-color-points-value-' + p)) {
            // update the legend if it already exists
            document.getElementById('legend-color-points-value-' + p).textContent = myColorStops[p][0];
            document.getElementById('legend-color-points-id-' + p).style.backgroundColor = myColorStops[p][1];
        }
        else {
            // create the legend if it doesn't yet exist
            var item = document.createElement('li');
            item.className = 'legend-item';
            var key = document.createElement('span');
            key.className = 'legend-key circle';
            key.id = 'legend-color-points-id-' + p;
            key.style.backgroundColor = myColorStops[p][1];
            var value = document.createElement('span');
            value.className = 'legend-value';
            value.id = 'legend-color-points-value-' + p;
            item.appendChild(key);
            item.appendChild(value);
            legendContent.appendChild(item);
            
            data = document.getElementById('legend-color-points-value-' + p)
            // round number values in legend if precision defined
            if ((typeof(myColorStops[p][0]) == 'number') && (typeof(null) == 'number')) {
                data.textContent = myColorStops[p][0].toFixed(null);
            }
            else {
                data.textContent = myColorStops[p][0];
            }
            // add color stop to gradient list
            if (false === true) {
                if (p < myColorStops.length - 1) {
                    gradientText = gradientText + myColorStops[p][1] + ', ';
                }
                else {
                    gradientText = gradientText + myColorStops[p][1] + ')';
                }
                if ('vertical' === 'vertical') {
                    gradientText = gradientText.replace('to right', 'to bottom');
                }
            }
        }
    }
    if (false === true) {
        // convert to gradient scale appearance
        gradient.style.background = gradientText;
        // hide legend keys generated above
        var keys = document.getElementsByClassName('legend-key');
        for (var i=0; i < keys.length; i++) {
            keys[i].style.visibility = 'hidden';
        }
        if ('vertical' === 'vertical') {
            gradient.style.height = (legendContent.offsetHeight - 6) + 'px';
        }
    }
    // add class for styling bordered legend keys
    if (true) {
        var keys = document.getElementsByClassName('legend-key');
        for (var i=0; i < keys.length; i++) {
            if (keys[i]) {
                keys[i].classList.add('bordered');
            }
        }
        var gradientBars = document.getElementsByClassName('gradient-bar');
        for (var i=0; i < keys.length; i++) {
            if (gradientBars[i]) {
                gradientBars[i].classList.add('bordered');
            }
        }
    }
    // update right-margin for compact Mapbox attribution based on calculated legend width
    updateAttribMargin(legend);
    updateLegendMargin(legend);
}


function calcRadiusLegend(myRadiusStops, title, color) {

    // maximum legend item height
    var maxLegendItemHeight = 2 * myRadiusStops[myRadiusStops.length - 1][1];

    // create legend
    var legend = document.createElement('div');
    legend.className = 'legend vertical legend-variable-radius';

    legend.id = 'legend-1';
    document.body.appendChild(legend);

    // add legend header and content elements
    var mytitle = document.createElement('div'),
        legendContent = document.createElement('ul');
    legendHeader = document.createElement('div');
    mytitle.textContent = title;
    mytitle.className = 'legend-title'
    legendHeader.className = 'legend-header'
    legendContent.className = 'legend-content'
    legendHeader.appendChild(mytitle);
    legend.appendChild(legendHeader);
    legend.appendChild(legendContent);

    // calculate a legend entries on a Mapbox GL Style Spec property function stops array
    for (p = 0; p < myRadiusStops.length; p++) {
        if (!!document.getElementById('legend-radius-points-value-' + p)) {
            //update the legend if it already exists
            document.getElementById('legend-radius-points-value-' + p).textContent = myRadiusStops[p][0];
            document.getElementById('legend-radius-points-id-' + p).style.backgroundColor = color;
        }
        else {
            // create the legend if it doesn't yet exist
            var item = document.createElement('li');
            item.className = 'legend-item';
            item.height = '' + maxLegendItemHeight + 'px';

            var key = document.createElement('span');
            key.className = 'legend-key circle';
            key.id = 'legend-radius-points-id-' + p;
            key.style.backgroundColor = color;   

            key.style.width = '' + myRadiusStops[p][1] * 2 + 'px';
            key.style.height = '' + myRadiusStops[p][1] * 2 + 'px';

            keyVerticalMargin = (maxLegendItemHeight - myRadiusStops[p][1] * 2) * 0.5;
            key.style.marginTop = '' + keyVerticalMargin + 'px';
            key.style.marginBottom = '' + keyVerticalMargin + 'px';

            var value = document.createElement('span');
            value.className = 'legend-value';
            value.id = 'legend-radius-points-value-' + p;

            item.appendChild(key);
            item.appendChild(value);
            legendContent.appendChild(item);
            
            data = document.getElementById('legend-radius-points-value-' + p)

            // round number values in legend if precision defined
            if ((typeof(myRadiusStops[p][0]) == 'number') && (typeof(null) == 'number')) {
                data.textContent = myRadiusStops[p][0].toFixed(null);
            }
            else {
                data.textContent = myRadiusStops[p][0];
            }
        }
    }

    // add class for styling bordered legend keys
    if (true) {
        var keys = document.getElementsByClassName('legend-key');
        for (var i=0; i < keys.length; i++) {
            if (keys[i]) {
                keys[i].classList.add('bordered');
            }
        }
    }

    // update right-margin for compact Mapbox attribution based on calculated legend width
    updateAttribMargin(legend);
    updateLegendMargin(legend);

}


function updateAttribMargin(legend) {

    // default margin is based on calculated legend width
    var attribMargin = legend.offsetWidth + 15;
    
    // if horizontal legend layout (multiple legends are stacked vertically)
    if ('vertical' === 'horizontal') {
        document.getElementsByClassName('mapboxgl-ctrl-attrib')[0].style.marginRight = (attribMargin).toString() + 'px';
    }
    // vertical legend layout means multiple legends are side-by-side
    else if ('vertical' === 'vertical') {
        var currentMargin = Number(document.getElementsByClassName('mapboxgl-ctrl-attrib')[0].style.marginRight.replace('px', ''));
        document.getElementsByClassName('mapboxgl-ctrl-attrib')[0].style.marginRight = (attribMargin + currentMargin).toString() + 'px';
    }
}


function updateLegendMargin(legend) {

    var verticalLegends = document.getElementsByClassName('legend vertical'),
        horizontalLegends = document.getElementsByClassName('legend horizontal');

    if (verticalLegends.length > 1) {
        for (i = 1; i < verticalLegends.length; i++) {
            verticalLegends[i].style.marginRight = (legend.offsetWidth - 5).toString() + 'px';
            var legend = verticalLegends[i];
        }
    }
    else if (horizontalLegends.length > 1) {
        for (i = 1; i < horizontalLegends.length; i++) {
            horizontalLegends[i].style.marginBottom = (legend.offsetHeight + 15).toString() + 'px';
            var legend = horizontalLegends[i];
        }
    }
}


function generateInterpolateExpression(propertyValue, stops) {
    var expression;
    if (propertyValue == 'zoom') {
        expression = ['interpolate', ['exponential', 1.2], ['zoom']]
    }
    else if (propertyValue == 'heatmap-density') {
        expression = ['interpolate', ['linear'], ['heatmap-density']]
    }
    else {
        expression = ['interpolate', ['linear'], ['get', propertyValue]]
    }

    for (var i=0; i<stops.length; i++) {
        expression.push(stops[i][0], stops[i][1])
    }
    return expression
}


function generateMatchExpression(propertyValue, stops, defaultValue) {
    var expression;
    expression = ['match', ['get', propertyValue]]
    for (var i=0; i<stops.length; i++) {
        expression.push(stops[i][0], stops[i][1])
    }
    expression.push(defaultValue)
    
    return expression
}


function generatePropertyExpression(expressionType, propertyValue, stops, defaultValue) {
    var expression;
    if (expressionType == 'match') {
        expression = generateMatchExpression(propertyValue, stops, defaultValue)
    }
    else if (propertyValue == 'identity') {
        expression = ['get', propertyValue]
    }
    else {
        expression = generateInterpolateExpression(propertyValue, stops)
    }

    return expression
}

</script>

<!-- main map creation code, extended by mapboxgl/templates/clustered_circle.html -->
<script type="text/javascript">

    mapboxgl.accessToken = 'pk.eyJ1IjoicXlpbmhlbGVuYSIsImEiOiJja2dlOXBsZHUwbmFzMnhxZnZ0N2RkeHQ0In0.NG8Rw75-oF3J-fX0HbXbOQ';

    var transformRequest = function(url, resourceType) {
        const isMapboxRequest = url.slice(8, 22) === 'api.mapbox.com' ||
          url.slice(10, 26) === 'tiles.mapbox.com';
      
        return {
          url: isMapboxRequest ? url.replace('?', '?pluginName=PythonMapboxgl&') : url
        }
    };

    var map = new mapboxgl.Map({
        container: 'map',
        attributionControl: false,
        style: 'mapbox://styles/mapbox/light-v10?optimize=true',
        center: [-118, 37],
        zoom: 4.5,
        pitch: 0,
        bearing: 0,
        scrollZoom: true,
        touchZoom: true,
        doubleClickZoom: true,
        boxZoom: true,
        preserveDrawingBuffer: false,
        transformRequest: transformRequest
    });

    
    
        map.addControl(new mapboxgl.AttributionControl({ compact: true }));

    

    

        map.addControl(new mapboxgl.NavigationControl());

    

    
    
    
        calcColorLegend([[1, 'rgb(239,243,255)'], [10, 'rgb(198,219,239)'], [25, 'rgb(158,202,225)'], [50, 'rgb(107,174,214)'], [75, 'rgb(66,146,198)'], [100, 'rgb(33,113,181)'], [1000, 'rgb(8,69,148)']], "Point Density");
    



    
        
        

    

    

    map.on('style.load', function() {
        
        

        map.addSource("data", {
            "type": "geojson",
            "data": {"type": "FeatureCollection", "features": [{"type": "Feature", "geometry": {"type": "Point", "coordinates": [-116.3954, 33.8124]}, "properties": {"fuel_type_code": "HY", "facility_type": "FLEET_GARAGE", "hy_is_retail": false, "hy_pressures": ["350"], "hy_standards": null}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.8564, 33.6635]}, "properties": {"fuel_type_code": "HY", "facility_type": "COLLEGE_CAMPUS", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.3146, 33.8586]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.3779, 33.9414]}, "properties": {"fuel_type_code": "HY", "facility_type": "AIRPORT", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.387, 33.2144]}, "properties": {"fuel_type_code": "HY", "facility_type": "MIL_BASE", "hy_is_retail": false, "hy_pressures": null, "hy_standards": null}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-122.2816, 37.8343]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.8784, 33.6252]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.3133, 33.8438]}, "properties": {"fuel_type_code": "HY", "facility_type": "STANDALONE_STATION", "hy_is_retail": false, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-122.1331, 37.4189]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.8377, 33.8559]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.3587, 34.0764]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.7243, 34.0238]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": false, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.1736, 34.0622]}, "properties": {"fuel_type_code": "HY", "facility_type": "COLLEGE_CAMPUS", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-122.0515, 37.3225]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-121.9546, 37.2719]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-120.2394, 36.253]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.9186, 33.6487]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-122.1064, 37.6667]}, "properties": {"fuel_type_code": "HY", "facility_type": "CONVENIENCE_STORE", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.1912, 34.2]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-121.9685, 37.5222]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.6685, 33.6615]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.1897, 33.8192]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.314, 34.1013]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.4215, 33.9631]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-122.518, 37.8888]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.836, 34.1687]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.24, 32.9336]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-121.9188, 37.3733]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-119.751, 34.4382]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-121.9993, 37.2842]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.1498, 34.1119]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-122.406, 37.6479]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-120.2235, 39.3249]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.361, 33.8894]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.3918, 33.7792]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": null, "hy_pressures": null, "hy_standards": null}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-122.2643, 37.3865]}, "properties": {"fuel_type_code": "HY", "facility_type": "STANDALONE_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.4106, 33.9226]}, "properties": {"fuel_type_code": "HY", "facility_type": "MUNI_GOV", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-121.9716, 37.7717]}, "properties": {"fuel_type_code": "HY", "facility_type": "STANDALONE_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-122.0671, 37.4051]}, "properties": {"fuel_type_code": "HY", "facility_type": "CONVENIENCE_STORE", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-122.2046, 37.7615]}, "properties": {"fuel_type_code": "HY", "facility_type": "FLEET_GARAGE", "hy_is_retail": false, "hy_pressures": ["350"], "hy_standards": null}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.667, 33.5197]}, "properties": {"fuel_type_code": "HY", "facility_type": "CONVENIENCE_STORE", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.4696, 34.0253]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.6054, 34.1664]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-121.5214, 38.5694]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.6115, 34.0631]}, "properties": {"fuel_type_code": "HY", "facility_type": "CONVENIENCE_STORE", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-122.4406, 38.2594]}, "properties": {"fuel_type_code": "HY", "facility_type": "BREWERY_DISTILLERY_WINERY", "hy_is_retail": false, "hy_pressures": ["350"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-122.3949, 37.7806]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-122.4237, 37.7402]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-122.287, 37.8695]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-122.4085, 37.7733]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.4484, 34.1506]}, "properties": {"fuel_type_code": "HY", "facility_type": "STANDALONE_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-122.0319, 37.3523]}, "properties": {"fuel_type_code": "HY", "facility_type": "FUEL_RESELLER", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-122.2557, 37.8092]}, "properties": {"fuel_type_code": "HY", "facility_type": "STANDALONE_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.1545, 32.774]}, "properties": {"fuel_type_code": "HY", "facility_type": "STANDALONE_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-121.3825, 38.5739]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-121.9438, 37.2946]}, "properties": {"fuel_type_code": "HY", "facility_type": "STANDALONE_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-121.3206, 38.6796]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.3627, 34.137]}, "properties": {"fuel_type_code": "HY", "facility_type": "STANDALONE_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-122.2345, 37.4941]}, "properties": {"fuel_type_code": "HY", "facility_type": "STANDALONE_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.4712, 34.2715]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-121.7729, 37.2323]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-122.2815, 37.8342]}, "properties": {"fuel_type_code": "HY", "facility_type": "FLEET_GARAGE", "hy_is_retail": null, "hy_pressures": ["350"], "hy_standards": null}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.9537, 33.6944]}, "properties": {"fuel_type_code": "HY", "facility_type": "STANDALONE_STATION", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.4193, 34.0113]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": null, "hy_standards": null}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.7852, 33.5433]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": false, "hy_pressures": null, "hy_standards": null}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.8305, 34.0013]}, "properties": {"fuel_type_code": "HY", "facility_type": "OFFICE_BLDG", "hy_is_retail": true, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.9269, 33.7034]}, "properties": {"fuel_type_code": "HY", "facility_type": "FLEET_GARAGE", "hy_is_retail": null, "hy_pressures": ["350"], "hy_standards": ["J2601-2"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.4119, 33.924]}, "properties": {"fuel_type_code": "HY", "facility_type": "MUNI_GOV", "hy_is_retail": null, "hy_pressures": ["350", "700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-122.0641, 37.975]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.8762, 33.862]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.7076, 33.5733]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.9604, 34.0723]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-121.8427, 37.277]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.8353, 33.7783]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.8862, 33.6797]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.182, 32.7432]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.3516, 33.7991]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.6514, 34.0341]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.3452, 34.1648]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.1641, 32.7227]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-121.8794, 37.3411]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.2792, 34.0662]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-122.3043, 37.9022]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.0832, 32.977]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.9978, 33.8678]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.2535, 34.2322]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-121.9773, 37.2355]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-121.9219, 37.4774]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-122.1147, 37.3999]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.3534, 34.0409]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.1431, 33.803]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.0353, 34.0269]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.0827, 33.8734]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.0146, 34.1407]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.3111, 33.0998]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.3608, 33.8725]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.6017, 33.8787]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.9412, 33.8475]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.4369, 34.0633]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-117.9768, 33.9081]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}, {"type": "Feature", "geometry": {"type": "Point", "coordinates": [-118.0814, 33.8318]}, "properties": {"fuel_type_code": "HY", "facility_type": "GAS_STATION", "hy_is_retail": true, "hy_pressures": ["700"], "hy_standards": ["J2601"]}}]},
            "buffer": 0,
            "maxzoom": 10 + 1,
            "cluster": true,
            "clusterMaxZoom": 10,
            "clusterRadius": 30,
            "generateId": true
        });

        map.addLayer({
            "id": "label",
            "source": "data",
            "type": "symbol",
            "maxzoom": 24,
            "minzoom": 0,
            "layout": {
                "text-field": "{point_count_abbreviated}",
                "text-size" : generateInterpolateExpression('zoom', [[0, 12],[22, 3* 12]] ),
            },
            "paint": {
                "text-halo-color": "white",
                "text-halo-width": generatePropertyExpression('interpolate', 'zoom', [[0,1], [18,5* 1]]),
                "text-color": ["case",
                    ["boolean", ["feature-state", "hover"], false], 
                    "black", 
                    "#131516"]
            }
        }, "" )

        map.addLayer({
            "id": "circle-cluster",
            "source": "data",
            "type": "circle",
            "maxzoom": 24,
            "minzoom": 0,
            "filter": ["has", "point_count"],
            "paint": {
                "circle-color": ["case",
                    ["boolean", ["feature-state", "hover"], false], 
                    "black", 
                    generateInterpolateExpression( "point_count", [[1, 'rgb(239,243,255)'], [10, 'rgb(198,219,239)'], [25, 'rgb(158,202,225)'], [50, 'rgb(107,174,214)'], [75, 'rgb(66,146,198)'], [100, 'rgb(33,113,181)'], [1000, 'rgb(8,69,148)']] )],
                "circle-radius" : generateInterpolateExpression( "point_count", [[1, 5], [10, 10], [50, 15], [100, 20]] ),
                "circle-stroke-color": ["case",
                    ["boolean", ["feature-state", "hover"], false], 
                    "black", "black"],
                "circle-stroke-width": generatePropertyExpression('interpolate', 'zoom', [[0,0.1], [18,5* 0.1]]),
                "circle-opacity" : 0.9,
                "circle-stroke-opacity" : 0.9
            }
        }, "label");

        map.addLayer({
            "id": "circle-unclustered",
            "source": "data",
            "type": "circle",
            "maxzoom": 24,
            "minzoom": 0,
            "filter": ["!has", "point_count"],
            "paint": {
                "circle-color": ["case",
                    ["boolean", ["feature-state", "hover"], false], 
                    "black", 
                    "black"],
                "circle-radius" : generateInterpolateExpression( 'zoom', [[0, 2 ], [22,10 * 2]]),
                "circle-stroke-color": ["case",
                    ["boolean", ["feature-state", "hover"], false], 
                    "black", 
                    "black"],
                "circle-stroke-width": generatePropertyExpression('interpolate', 'zoom', [[0,0.1], [18,5* 0.1]]),
                "circle-opacity" : 0.9,
                "circle-stroke-opacity" : 0.9
            }
        }, "circle-cluster");
        
        

        // Popups
        
            var popupAction = 'mousemove',
                popupSettings =  {
                    closeButton: false,
                    closeOnClick: false
                };
        

        // Create a popup
        var popup = new mapboxgl.Popup(popupSettings);
        
        

        var hoveredStateId = 0;
        
        // Show the popup on mouseover
        map.on(popupAction, function(e) {
            
            var features = map.queryRenderedFeatures(e.point, {layers: ['circle-unclustered', 'circle-cluster', 'label'] });

            if (features.length > 0) {
                map.getCanvas().style.cursor = 'pointer';
                var f = features[0];
                newHoveredStateId = f.id;
                if (newHoveredStateId != hoveredStateId) {
                    map.removeFeatureState({source: 'data', id: hoveredStateId});
                    hoveredStateId = newHoveredStateId;
                }
                map.setFeatureState({source: 'data', id: hoveredStateId}, { hover: true});
                let popup_html = '<div><li><b>Location</b>: ' + f.geometry.coordinates[0].toPrecision(6) + 
                    ', ' + f.geometry.coordinates[1].toPrecision(6) + '</li>';

                for (key in f.properties) {
                    popup_html += '<li><b> ' + key + '</b>: ' + f.properties[key] + ' </li>'
                }

                popup_html += '</div>'
                popup.setLngLat(e.lngLat)
                    .setHTML(popup_html)
                    .addTo(map);
            }
            else {
                map.getCanvas().style.cursor = '';
                popup.remove();
                map.removeFeatureState({source: 'data', id: hoveredStateId});
            }
        });

        
        
        map.on('click', 'circle-unclustered', function(e) {
            map.easeTo({
                center: e.features[0].geometry.coordinates
            });
        });

        map.on('click', 'circle-cluster', function(e) {
            map.easeTo({
                center: e.features[0].geometry.coordinates
            });
        });
    });



</script>

<!-- add capability to export map or legend to image file -->


</body>
</html>